---
title: "evolSOM vignette"
author: "Santiago Prochetto"
date: Last modified "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{my-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# About evolSOM

# About

In recent years, we have witnessed a surge in technological advancements in the field of life sciences. Researchers now have access to extensive biobanks and can collect vast amounts of multimodal data, including data from omics studies across multiple organisms, which is crucial for understanding evolution. As technical developments continue to progress, the demand for information systems capable of managing heterogeneous data is on the rise. One of the key challenges of this new era is the development of robust tools capable of integrating diverse data types to uncover hidden patterns and relationships among heterogeneous sources. We here introduce evolSOM, a novel tool based on unsupervised machine learning that facilitates the discovery of variations between multimodal data and offers an intuitive way to visualize hidden patterns within complex data matrices. Specifically, evolSOM clusters genes and/or phenotypic traits based on their expression patterns and maps these features across different species to assess their conservation throughout evolution. This vignette provides a detailed overview of the most essential functions within the evolSOM package and outlines the overall process for analyzing feature displacement. Feature displacement is a crucial aspect, as it allows us to uncover intrinsic evolutionary processes and changes. The general steps for using evolSOM are as follows:

1.  Import data and perform scaling.

2.  Construct a reference SOM (Self-Organizing Map).

3.  Map features within the reference SOM.

4.  Characterize displacement types.

5.  Create a network dataframe to quantify and visualize displacements.

6.  Generate displacement plots to gain insights into the data.

# Installation

```{r setup}
#devtools::install_github("sanprochetto/evolSOM")
library(evolSOM)
library(ggplot2)
```

# Example: Using evolSOM to Discover Potential Gene Drivers for Leaf Development in Grasses

In this example, we will demonstrate how to use evolSOM to identify potential gene drivers for leaf development in grasses. We'll go through the following steps:

## Step 1: Importing Data and Scaling

### 1.1 Data Import

First, we need to import our dataset. The dataset consists of a dataframe containing a list of genes and phenotypic traits. These genes and traits have been measured in leaf segments at four different developmental stages and across three closely related species. Additionally, we require an extra dataframe that provides useful information about each feature. This information can include details such as the feature type (gene or phenotypic trait), the biological processes in which the feature is involved, the gene family to which the feature belongs, and more.

```{r}
#Traits expression data (genes + phenotype)
datSOM <- datSOM
head(datSOM)

#Traits names and information (tags) 
classSOM <- classSOM #First column must be name of feature/gen
```

### 1.2 Feature Scaling

After importing the data, the next crucial step is to scale each feature to unit variance. This ensures that all features have the same level of influence during the analysis, preventing any feature from dominating the results due to differences in scale. Feature scaling is essential for accurate and meaningful insights from evolSOM.

We can achieve feature scaling using the scale_species() function, which scales the data from each species individually. The output is a list containing one dataframe for each species. The reference species should be the first element in the list:

```{r}
datSOM.scaled <- scale_species(datSOM[,9:12], datSOM[,5:8], datSOM[,1:4], 
                               rnames= row.names(datSOM),
                               species_names = c("C3", "PK", "C4"))
head(datSOM.scaled[[1]])

head(datSOM.scaled[[2]])

head(datSOM.scaled[[3]])

```

## Step 2 - Build a reference SOM

### 2.1 Optimal size of the grid

Before constructing the reference SOM, it's essential to estimate the optimal size of the grid. The optimal size is where all expression patterns in your data are accurately represented by neurons, ensuring that each pattern is unique. The grid size depends on the number of conditions under which the data was measured. Estimating the grid size manually can be challenging, time-consuming, and may require several iterations, especially for those who are not familiar with Self-Organizing Maps (SOM). To streamline this process, we provide a script that automates the search for the optimum grid size using the opt_map_size() function. The result, map_size, will provide you with the optimal grid dimensions.

```{r}
map_size <- opt_map_size(data = na.omit(datSOM.scaled[[1]]), # Reference species data (without NA)
                     threshold = 0.8,          # Maximum allowed correlation for neurons
                     init_dim = 5,  # Initial grid size (e.g., 5x5)
                     max_iterations = 10)   # Maximum iterations when training the SOM model 

map_size
```

### 2.2 Optimal size of the grid

To build the reference SOM, we use functions from the kohonen and aweSOM packages:

```{r}
train.data <- as.matrix(na.omit(datSOM.scaled[[1]])) # Select variables for the reference species
dim1<- map_size[["grid_dim1"]]
dim2<- map_size[["grid_dim2"]]
set.seed(100) # Set the random number generator seed for reproducibility
# Initialize the SOM using the aweSOM package
  init <- aweSOM::somInit(train.data, dim1, dim2)
  # Train the SOM using the kohonen package
  model.som <- kohonen::som(train.data,
                          grid = kohonen::somgrid(dim1, dim2, "hexagonal"), 
                    rlen = 1000, alpha = c(0.1, 0.001), 
                    dist.fcts = "euclidean", init = init)
  
  # Visualize the reference SOM using the aweSOM package
  aweSOM::aweSOMplot(som = model.som, type = "Line", data = train.data, 
           variables = colnames(train.data), 
           values = "prototypes", size= 400)
```

## Step 3 - Map features within the reference SOM.

### 3.1 Create mappings

Let's briefly explain how to map features within the reference SOM. In this step, we utilize the create_mappings() function to create mappings and class assignments based on a trained model and input data. The mappings object stores valuable information about the mappings, such as class assignments and number of features allocated to each neuron.

```{r}
mappings <- create_mappings(model = model.som,
                            train_data = train.data,
                            data_list = datSOM.scaled, 
                            species_names = names(datSOM.scaled), 
                            classes = classSOM)

#Explore info inside mappings:
head(mappings[["classes"]], 15)
head(mappings[["neurons_sizes"]],15)
```

### 3.2 Neurons sizes graph

Now, let's take a look at the neuron sizes graph to gain insights into the number of features residing within each neuron:

```{r,fig.align = 'center', out.width="50%"}
figure <- ggplot(mappings[["neurons_sizes"]], aes(x = as.character(Neuron), y = size, fill = species)) +
   geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  scale_fill_manual(values = c("#7ed977", "#008f77", "#009ca6" ))+
 theme_bw() 

figure
```

## Step 4 - Characterizing displacement types

To uncover hidden evolutionary patterns, the package identifies movements, or displacements, of features among neurons within the Self-Organizing Map (SOM). When a feature from a test species is mapped to the same neuron as in the reference species, it is considered evolutionary preserved. If it is mapped to a different neuron, it is considered displaced. These feature movements can also be categorized into various types, such as early, delayed, flip, and more.

You can automatically detect displacement types using the create_displacements() function:

```{r}
displacements<-  create_displacements(model.som,
                                      delay_threshold = 0.75,
                                      flip_threshold = -0.85)

displacements
```

The displacements object will provide information about the detected displacement types. If you need to further characterize a displacement based on additional criteria, you can manually edit the displacements dataframe as needed. This step allows for a more detailed exploration of displacement patterns in your data.

## 5 - Creating a Network Dataframe to Count and Visualize Displacements

To gain insights into the nature of evolutionary displacements, we employ the create_net_edges() function to generate a displacement graph. This function constructs a dataframe that counts the number of displacements between neurons and species pairs

```{r}
net_edges_C3toPK <- create_net_edges(mappings =  mappings, #object returned from mapping()
                                     "Reference.sp", "PK",  #Species names: "start", "end"
                                     add_disp_type = TRUE,  # choose to add displacement types
                                     disp_type = displacements) #where to find disp types info
head(net_edges_C3toPK, 10)
```

The net_edges_C3toPK dataframe provides valuable information about the number and types of displacements between neurons and species. You can use this data to create visualizations and gain insights into the evolutionary changes and relationships between the reference species (C3) and the test species (PK)

## 6 - Plot the displacements

### 6.1 General displacements

You can use the displacements_graph() function to observe the extent of feature displacements between species. With this visualization, you can gain insights into the extent and quality of feature displacements between species.

```{r,fig.align = 'center', out.width="100%"}
 displacements_graph(mappings = mappings,  # Looks for nodes inside mapping mapping[["neurons_sizes"]]
                 links =  net_edges_C3toPK, #the arrows in the graph
                 reference_species = "C3", #used for determine the size of the neurons
                 layout="circle",  #from igraph: circle, linear, grid, etc.
                 node_order=c(1,4,5,2,6,3),  #use a specific order for visualization purposes
                #node_order = NULL,
                 color_edges = "disp_type",  #Color the arrows by...
                color_scale=c("red","blue","green", "yellow", "orange", "violet")
                 )
```

### 6.2 Displacements of a specific group of features

You can also select a subset of features and visualize their displacements. For instance, based on the work of Prochetto et al., 2023, we have compiled a list of 25 genes related to the "photorespiration" process. This allows us to investigate whether there's a distinct pattern of displacement for this particular group of genes.

```{r, fig.align = 'center', out.width="100%"}
# Photorespiration (25) gene list
phr.genes <- c("OG0000295", "OG0000378", "OG0000783", "OG0000964", "OG0001962",
               "OG0002384", "OG0003519", "OG0003992", "OG0004041", "OG0004061",
               "OG0004294", "OG0004978", "OG0005385", "OG0005556", "OG0006771",
               "OG0007574", "OG0007822", "OG0008057", "OG0010248", "OG0012065",
               "OG0012541", "OG0000516", "OG0011137", "OG0001049", "OG0005515")

# Select genes from mappings[["classes"]]
selected_features <- mappings[["classes"]][mappings[["classes"]]$Feature %in% phr.genes,]
mappings_selected_features <- mappings
mappings_selected_features$classes <- selected_features



# Build net_edges for the list using the create_net_edges function
net_edges_pk_phr <- create_net_edges(mappings_selected_features, 
                                     "C3", "PK",
                                     add_disp_type = TRUE,
                                     disp_type = displacements)
head(net_edges_pk_phr, 10)

displacements_graph(mappings = mappings_selected_features,
                links = net_edges_pk_phr,
                reference_species = "C3",
                layout="grid", 
                node_order = NULL,
                color_edges = "disp_type"
                                )
```

With this analysis, you can explore the displacement patterns for this specific group of genes associated with "photorespiration." This can provide valuable insights into how these genes have evolved and their relationships between the reference species (C3) and the test species (PK).

## Citation

For more information, please refer to our paper:

"insert reference here"
